@page "/"
@using Lomboque.Application.Actions
@using System.Threading

@inject IHttpClientFactory ClientFactory
@inject DataController DataController


<PageTitle>Index</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.

<input type="text" name="sample" id="sample" placeholder="Sample">

<div>
    json: @json
</div>
<br>
<div>
    dto: @dto
</div>
<br>
<div>
    <h2>stack:</h2>
    @_stack
</div>

@code {

    private string? json;
    private string? dto;

    private string _stackMsg = "Pass...\n";
    private string? _stack;

    private async Task RunInBackground(TimeSpan timeSpan, Action action)
    {
        var periodicTimer = new PeriodicTimer(timeSpan);
        while (await periodicTimer.WaitForNextTickAsync())
        {
            action();
        }
    }
    

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender)
        {
            dto = DataController.CreateData();

            var request = new HttpRequestMessage(HttpMethod.Get, "http://192.168.2.118/get");
            var client = ClientFactory.CreateClient();
            var response = await client.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                using var responseStream = await response.Content.ReadAsStreamAsync();
                using var streamReader = new StreamReader(responseStream);

                json = streamReader.ReadToEnd();
                DataController.SerializeData(json);

                System.Console.WriteLine(json);
                this.StateHasChanged();
            }

            await RunInBackground(TimeSpan.FromSeconds(1), () => {
                @* Console.WriteLine("Printing"); *@
                _stack += _stackMsg;
                this.StateHasChanged();
            });
            
        }
    }


}